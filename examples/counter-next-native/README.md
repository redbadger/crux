# Crux Counter Example (Native Bridge)

> [!NOTE]
> This example uses `NativeBridge` with typed FFI via UniFFI annotations,
> designed for use with [uniffi-bindgen-react-native](https://github.com/jhugman/uniffi-bindgen-react-native).
>
> For the traditional byte-serialization approach, see [counter-next](../counter-next/README.md).

## Overview

This example demonstrates using Crux with **typed native FFI** instead of byte serialization.
The same UniFFI annotations generate bindings for:

- **React Native** (iOS/Android via JSI)
- **Web pages** (via generated WASM crate)

All from a single Rust codebase with UniFFI annotations.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    shared/ (Rust)                           │
│  - UniFFI annotations on types                              │
│  - NativeBridge for typed effect delivery                   │
│  - No byte serialization needed                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │  uniffi-bindgen-react-native  │
              │  (generates from UniFFI)      │
              └───────────────────────────────┘
                    │                   │
                    ▼                   ▼
        ┌───────────────────┐  ┌───────────────────┐
        │  React Native     │  │  WASM Crate       │
        │  (iOS/Android)    │  │  (Web pages)      │
        │  - JSI bindings   │  │  - TS bindings    │
        │  - Turbo Module   │  │  - wasm-bindgen   │
        └───────────────────┘  └───────────────────┘
```

## Key Differences from counter-next

| Aspect | counter-next | counter-next-native |
|--------|--------------|---------------------|
| FFI approach | Byte serialization (Bincode) | Typed FFI (UniFFI) |
| Effect delivery | `Vec<u8>` | Typed `EffectFfi` enum |
| Resolution | `resolve(id, &[u8])` | `resolve(id, EffectOutput)` |
| View | `view() -> Vec<u8>` | `view() -> ViewModel` |
| Web bindings | Manual wasm_bindgen | Generated by uniffi-bindgen-react-native |
| Shell callback | `\|bytes: Vec<u8>\|` | `\|id, effect: EffectFfi\|` |

## Building

### Prerequisites

1. Install Rust targets:
   ```sh
   rustup target add aarch64-apple-ios aarch64-apple-ios-sim aarch64-linux-android
   ```

2. Install [uniffi-bindgen-react-native](https://github.com/jhugman/uniffi-bindgen-react-native):
   ```sh
   cargo install uniffi-bindgen-react-native
   ```

### Generate TypeScript Bindings

```sh
# Generate bindings for React Native and Web
uniffi-bindgen-react-native generate shared/src/lib.rs --out-dir ./generated
```

This generates:
- TypeScript bindings for React Native (iOS/Android)
- A WASM crate for web pages

## Mobile Apps

### iOS

```sh
cd iOS
xed .
```

Press "Play" in Xcode to run in simulator or on device.

### Android

Open the `Android` folder in Android Studio and press "Play".

## Web Apps

> [!NOTE]
> Web support is provided via uniffi-bindgen-react-native generated WASM/TypeScript bindings.
> Run the binding generation step above, then use the generated TypeScript package in your web app.

## Shared Library

The shared Rust code is in `shared/` with:

- `src/app.rs` - Application logic (Event, Model, ViewModel)
- `src/ffi.rs` - UniFFI-annotated FFI types (EffectFfi, EffectOutput, NativeRequest)
- `src/capabilities/` - Custom capabilities (SSE)
- `src/middleware.rs` - Effect middleware (RNG)

### Key FFI Types

```rust
// Shell receives typed effects
#[derive(uniffi::Enum)]
pub enum EffectFfi {
    Render(RenderOperation),
    Http(HttpRequest),
    ServerSentEvents(SseRequest),
}

// Shell sends typed responses
#[derive(uniffi::Enum)]
pub enum EffectOutput {
    Render(UnitOutput),
    Http(HttpResult),
    ServerSentEvents(SseResponse),
}

// Shell-facing events
#[derive(uniffi::Enum)]
pub enum EventFfi {
    Get,
    Increment,
    Decrement,
    Random,
    StartWatch,
}
```

## API

The app calls a shared global counter at https://crux-counter.fly.dev:
- `GET /` - Get current count
- `POST /inc` - Increment
- `POST /dec` - Decrement
- `GET /sse` - Server-Sent Events stream

![screenshots](./counter.webp)
